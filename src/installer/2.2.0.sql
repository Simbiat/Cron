ALTER TABLE `cron__log` CHANGE `message` `message` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_nopad_ci NOT NULL COMMENT 'Message provided by the event';
ALTER TABLE `cron__tasks` ADD `minFrequency` INT(10) UNSIGNED NOT NULL DEFAULT '60' COMMENT 'Minimal allowed frequency (in seconds) at which a task instance can run. Does not apply to one-time jobs.' AFTER `maxTime`;
ALTER TABLE `cron__tasks` ADD `retry` INT UNSIGNED NOT NULL DEFAULT '0' COMMENT 'Custom number of seconds to reschedule a failed task instance for. 0 disables the functionality.' AFTER `minFrequency`;
CREATE TABLE `cron__event_types` (`type` VARCHAR(30) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_nopad_ci NOT NULL COMMENT 'Type of the event' , `description` VARCHAR(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_nopad_ci NOT NULL COMMENT 'Description of the event' ) ENGINE = InnoDB CHARSET=utf8mb4 COLLATE utf8mb4_unicode_nopad_ci COMMENT = 'Different event types for logging and SSE output';
ALTER TABLE `cron__event_types` ADD PRIMARY KEY(`type`);
ALTER TABLE `cron__log` DROP FOREIGN KEY `errors_to_tasks`;
ALTER TABLE `cron__log` ADD CONSTRAINT `log_to_tasks` FOREIGN KEY (`task`) REFERENCES `cron__tasks`(`task`) ON DELETE CASCADE ON UPDATE CASCADE;
INSERT INTO `cron__event_types` (`type`, `description`) VALUES ('CronStart', 'Start of cron processing.'), ('CronFail', 'Failure of cron processing.'), ('CronTaskStart', 'A task instance was started.'), ('CronTaskEnd', 'A task instance completed successfully.'), ('CronTaskFail', 'A task instance failed.'), ('CronEmpty', 'Empty list of tasks in the cycle.'), ('CronNoThreads', 'No free threads in this cycle.'), ('CronEnd', 'End of cron processing.'), ('Reschedule', 'A task instance was rescheduled.'), ('RescheduleFail', 'A task instance failed to be rescheduled.'), ('TaskAdd', 'A task was added or updated.'), ('TaskAddFail', 'A task failed to be added or updated.'), ('TaskDelete', 'A task was deleted.'), ('TaskDeleteFail', 'A task failed to be deleted.'), ('TaskToSystem', 'A task was marked as system one.'), ('TaskToSystemFail', 'A task failed to be marked as system one.'), ('InstanceAdd', 'A task instance was added or updated.'), ('InstanceAddFail', 'A task instance failed to be added or updated.'), ('InstanceDelete', 'A task instance was deleted.'), ('InstanceDeleteFail', 'A task instance failed to be deleted.'), ('InstanceToSystem', 'A task instance was marked as system one.'), ('InstanceToSystemFail', 'A task instance failed to be marked as system one.');
ALTER TABLE `cron__log` DROP FOREIGN KEY `log_to_tasks`;
ALTER TABLE `cron__log` ADD CONSTRAINT `cron_log_to_tasks` FOREIGN KEY (`task`) REFERENCES `cron__tasks`(`task`) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE `cron__log` ADD CONSTRAINT `cron_log_to_event_type` FOREIGN KEY (`type`) REFERENCES `cron__event_types`(`type`) ON DELETE CASCADE ON UPDATE CASCADE;
UPDATE `cron__event_types` SET `type` = 'InstanceEnd' WHERE `cron__event_types`.`type` = 'CronTaskEnd';
UPDATE `cron__event_types` SET `type` = 'InstanceFail' WHERE `cron__event_types`.`type` = 'CronTaskFail';
UPDATE `cron__event_types` SET `type` = 'InstanceStart' WHERE `cron__event_types`.`type` = 'CronTaskStart';
UPDATE `cron__event_types` SET `type` = 'SSEEnd' WHERE `cron__event_types`.`type` = 'CronEnd';
UPDATE `cron__event_types` SET `description` = 'End of cron processing in SSE mode.' WHERE `cron__event_types`.`type` = 'SSEEnd';
UPDATE `cron__event_types` SET `type` = 'SSEStart' WHERE `cron__event_types`.`type` = 'CronStart';
UPDATE `cron__event_types` SET `description` = 'Start of cron processing in SSE mode.' WHERE `cron__event_types`.`type` = 'SSEStart';
UPDATE `cron__settings` SET `value` = '2.2.0' WHERE `cron__settings`.`setting` = 'version';